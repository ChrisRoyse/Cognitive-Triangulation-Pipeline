# Master Acceptance Test Plan-- Cognitive Triangulation (Resilient Architecture)

## 1. Introduction and Vision

This document defines the revised master acceptance testing strategy for the "Cognitive Triangulation" code analysis pipeline, updated to validate the new resilient, hierarchical architecture. Its purpose is to outline the high-level, end-to-end tests that define the ultimate success criteria for the project, directly addressing the flaws identified in the Devil's Advocate critique.

The vision is to validate a system that performs deep semantic analysis of a polyglot codebase with verifiable correctness and resilience. The tests focus on the *quality and accuracy* of the generated knowledge graph, not just its size.

## 2. Overall Testing Strategy

The strategy shifts from validating entity counts to verifying the **correctness of specific, complex insights** generated by the pipeline. It is a black-box approach that validates the final graph state against the ground truth of a controlled test codebase.

### Key Principles--
-   **Correctness over Counts**-- Tests will assert that specific, known relationships are identified correctly, with high confidence, and that hallucinated relationships are absent.
-   **Resiliency Validation**-- Tests will explicitly check that the system's self-correction and multi-attempt mechanisms are functioning.
-   **Hierarchical Verification**-- Tests will validate that file-level, directory-level, and global-level analyses are performed and aggregated correctly.
-   **AI-Verifiable Outcomes**-- Each test case concludes with specific Cypher queries that programmatically verify the graph's state, enabling automated validation.
-   **Controlled Test Data**-- All tests will run against the `polyglot-test/` directory to ensure deterministic and repeatable results.

## 3. High-Level Acceptance Tests

---

### **Test ID-- A-01-- High-Confidence Relationship Validation**

-   **Description**-- This test supersedes the original graph generation test. It validates that the pipeline can correctly identify a complex, cross-language relationship with a high degree of confidence, proving the core analysis is accurate.
-   **Preconditions**-- The Neo4j database is empty.
-   **Test Steps**-- Execute the full analysis pipeline against the `polyglot-test` directory.
-   **Expected Result (AI-Verifiable Completion Criterion)**--
    1.  A Cypher query to find the specific `CALLS` relationship between the Python function `data_processor.py/process_data` and the JavaScript function `utils.js/formatData` must return exactly one relationship.
    2.  The returned relationship must have a `confidence` score greater than `0.9`.
    3.  The relationship's `explanation` property must not be empty and should contain text indicating successful multi-model validation.
    4.  A Cypher query must confirm that no relationship exists between two known-unrelated POIs (e.g., `python/utils.py/helper_function` and `java/User.java/getUsername`), directly testing for hallucinations.

---

### **Test ID-- A-02-- Resiliency and Self-Correction**

-   **Description**-- This test verifies the system's resilience to intermittent LLM failures. It checks that the pipeline correctly records its analysis attempts, demonstrating that the self-correction loop is operational.
-   **Preconditions**-- The graph from a full pipeline run exists.
-   **Test Steps**-- Inspect the graph state after the pipeline execution.
-   **Expected Result (AI-Verifiable Completion Criterion)**--
    1.  A Cypher query `MATCH (f:File {name: 'polyglot-test/js/auth.js'}) RETURN f.analysisStatus, f.analysisAttempts` must show that the file's status is `COMPLETED`.
    2.  The `analysisAttempts` property on the node must be a positive integer (e.g., >= 1). This confirms the property is being set. (A more advanced test could mock an LLM failure to ensure this number increments).
    3.  All `File` nodes in the graph with a status of `COMPLETED` must have an associated `FileAnalysisReport` node.

---

### **Test ID-- A-03-- Idempotency of Updates**

-   **Description**-- This test ensures that re-running the pipeline on an unchanged codebase does not create duplicate data, and that running it on a modified codebase correctly updates the graph.
-   **Preconditions**-- A successful run of test A-01 has been completed.
-   **Test Steps**--
    1.  Get the initial counts of all nodes and relationships.
    2.  Re-run the full analysis pipeline on the *same* `polyglot-test` directory.
    3.  Verify counts have not changed.
    4.  (Future enhancement) Modify a single line in a test file and re-run, verifying that the `checksum` on the corresponding `:File` node is updated, but node counts remain the same.
-   **Expected Result (AI-Verifiable Completion Criterion)**--
    1.  Cypher queries for node and relationship counts executed before and after the second pipeline run must return the exact same numbers.
    2.  A query for a specific node's properties (e.g., `MATCH (p:POI {name: 'getUser'}) RETURN p.startLine`) must return the same value before and after the run.

---

### **Test ID-- A-04-- Advanced Code Discovery and Queryability**

-   **Description**-- This test validates the business goal of using the graph for deep code discovery. It poses a complex question that requires traversing multiple relationship types, proving the graph's practical utility.
-   **Preconditions**-- The graph from a full pipeline run exists.
-   **Test Steps**-- Execute a complex Cypher query against the populated graph.
-   **Expected Result (AI-Verifiable Completion Criterion)**--
    1.  A Cypher query that answers, "What are the names of the JavaScript functions that are called by Python functions which, in turn, interact with the database via the `database_client.py` module?" must return the correct, known function name (e.g., `server.js/getAuthenticatedUser`). This query involves traversing `IMPORTS`, `CALLS`, and `INTERACTS_WITH` relationships across files and languages.

---

### **Test ID-- A-05-- Hierarchical Analysis Validation**

-   **Description**-- This new test specifically validates the hierarchical analysis process. It ensures that directory-level summaries are created and that these summaries are used to infer higher-level, cross-directory relationships.
-   **Preconditions**-- The graph from a full pipeline run exists.
-   **Test Steps**-- Execute Cypher queries to inspect the hierarchical structures in the graph.
-   **Expected Result (AI-Verifiable Completion Criterion)**--
    1.  A Cypher query `MATCH (d:Directory {name: 'polyglot-test/python'}) RETURN d.summary` must return a non-empty string representing the AI-generated summary of the directory's contents.
    2.  A Cypher query must find a `:CONTAINS` relationship between the `Directory` node for `polyglot-test/js` and the `:POI` node for the `getUser` function.
    3.  A Cypher query must find a high-level relationship (e.g., `:USES_AUTHENTICATION_MODEL`) between a POI in the `python` directory and a POI in the `js` directory, where this relationship includes a property `inferredFrom: 'directory-summary'`, proving the hierarchy was used.