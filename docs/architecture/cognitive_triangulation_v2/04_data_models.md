# Cognitive Triangulation v2 -- Key Data Models (Revised)

This document serves as the single source of truth for the schemas of the key data structures and database tables used throughout the revised Cognitive Triangulation v2 system.

These definitions are derived from [`docs/specifications/cognitive_triangulation/job_data_models_v2_specs.md`](../../specifications/cognitive_triangulation/job_data_models_v2_specs.md) and have been updated to reflect the new architecture.

## 1. Redis Data Models

### 1.1. `runManifest`

-   **Location--** Stored in Redis, keyed by `manifest:{runId}`.
-   **Purpose--** The master plan for an analysis run. It is created by `EntityScout` with a pre-computed list of candidate relationships and is read by `ValidationWorker` to orchestrate reconciliation.

#### Schema

```json
{
  "runId": "string",
  "jobGraph": {
    "file-analysis": ["string"],
    "directory-resolution": ["string"],
    "global-resolution": ["string"]
  },
  "relationshipEvidenceMap": {
    "string -- (relationshipHash)": {
        "expectedEvidenceCount": "number",
        "jobIds": ["string -- (jobId)"]
    }
  }
}
```

#### Field Descriptions

-   `relationshipEvidenceMap`-- A dictionary where the key is the relationship hash.
    -   `expectedEvidenceCount`-- The total number of pieces of evidence expected for this relationship.
    -   `jobIds`-- An array of job IDs expected to provide an opinion on this relationship.

### 1.2. `evidenceCounter`

-   **Location--** Stored in Redis, keyed by `evidence_count:{runId}:{relationshipHash}`.
-   **Purpose--** A simple atomic counter used by the `ValidationWorker` to track the number of evidence payloads received for a specific relationship.

## 2. SQLite Table Schemas

### 2.1. `relationships` Table

-   **Purpose--** Stores the state of each relationship as it moves through the validation pipeline.

```sql
CREATE TABLE relationships (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    run_id TEXT NOT NULL,
    relationship_hash TEXT NOT NULL,
    source_poi TEXT NOT NULL,
    target_poi TEXT NOT NULL,
    type TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'PENDING_VALIDATION', -- PENDING_VALIDATION, VALIDATED, CONFLICT
    confidence_score REAL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(run_id, relationship_hash)
);
```

### 2.2. `relationship_evidence` Table

-   **Purpose--** The primary storage for the full evidence payloads generated by analysis workers. This replaces the old pattern of storing this data in Redis.

```sql
CREATE TABLE relationship_evidence (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    run_id TEXT NOT NULL,
    relationship_hash TEXT NOT NULL,
    source_worker TEXT NOT NULL,
    found_relationship BOOLEAN NOT NULL,
    initial_score REAL NOT NULL,
    raw_llm_output TEXT, -- Stored as a JSON string
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_evidence_run_hash ON relationship_evidence(run_id, relationship_hash);
```

### 2.3. `outbox` Table

-   **Purpose--** Implements the Transactional Outbox Pattern. Workers write event payloads here as part of the same transaction in which they write their evidence.

```sql
CREATE TABLE outbox (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    payload TEXT NOT NULL, -- The full JSON payload of the event
    status TEXT NOT NULL DEFAULT 'PENDING', -- PENDING, PUBLISHED
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 3. BullMQ Data Models

### 3.1. `AnalysisCompletedEvent`

-   **Location--** Passed as a message payload within BullMQ, published from the `outbox` table.
-   **Purpose--** The standardized event structure that all analysis workers use to signal their completion.

#### Schema

```json
{
  "runId": "string",
  "jobId": "string",
  "sourceWorker": "string",
  "findings": [
    {
      "relationshipHash": "string"
      // Note-- The full evidence is NOT in the event.
      // The event is now just a lightweight notification.
    }
  ]
}
```

#### Field Descriptions

-   The event is now significantly lighter. It acts as a notification to trigger the `ValidationWorker`, which then looks up the relevant data in Redis (counters) and SQLite (evidence).