# Specification-- GlobalResolutionWorker (v2)

This document provides the detailed specification for the modified `GlobalResolutionWorker` as part of the Cognitive Triangulation v2 architecture.

## 1. Purpose and Role

The `GlobalResolutionWorker` performs the third and final pass of analysis. It is triggered after all `DirectoryResolutionWorker` jobs for a run are complete. Its purpose is to identify the highest-level relationships--those that exist *between* different directories. It provides the broadest possible context for validating relationships, looking for architectural patterns and cross-cutting concerns.

Like the other workers in v2, it operates as an independent analysis engine that publishes its findings as an event for the `ValidationCoordinator`.

## 2. Dependencies

-- **Module/Service** -- **Purpose**
-- --- -- ---
-- `bullmq` -- To process jobs from the `global-resolution-queue` and publish completion events.
-- `sqliteDb` -- To read the directory summaries generated by the `DirectoryResolutionWorker` jobs.
-- `deepseekClient` (or `LlmClient` abstraction) -- To communicate with the LLM.
-- `ConfidenceScoringService` -- To get an initial confidence score for each relationship it identifies.
-- `logger` -- For structured logging.

## 3. Class Definition-- `GlobalResolutionWorker`

### 3.1. Overview

The `GlobalResolutionWorker` class processes the single job from the `global-resolution-queue` for a given run.

### 3.2. Existing Methods (Modified)

#### `processJob(job)`

-   **Purpose**: The main job processing logic for the entire codebase.
-   **Parameters**:
    -   `job` (Object)-- The BullMQ job object. The `job.data` payload will contain--
        -   `runId` (String)
-   **Modified Logic**:
    1.  Query `sqliteDb` to retrieve all directory summaries for the given `runId`.
    2.  Construct a high-level context for the LLM consisting of these summaries.
    3.  Call the LLM to identify cross-directory relationships.
    4.  **New**: For each relationship identified in this global pass, calculate its `initialScore` using `ConfidenceScoringService.getInitialScoreFromLlm()`.
    5.  **New**: As with the directory worker, this worker also provides a final opinion on relationships found by lower-level passes. It will create findings for relationships it evaluates.
    6.  **New**: Construct an `AnalysisCompletedEvent` payload.
    7.  **New**: Publish a `global-analysis-completed` event for the `ValidationCoordinator`.
-   **Returns**: `Promise<void>`

## 4. TDD Anchors / Pseudocode Stubs

```
// TEST-- 'GlobalResolutionWorker should fetch all directory summaries for the run'
// TEST-- 'GlobalResolutionWorker should call the LLM with a context of all directory summaries'
// TEST-- 'GlobalResolutionWorker should publish a "global-analysis-completed" event'
// TEST-- 'The event from GlobalResolutionWorker should trigger the final reconciliation in the ValidationCoordinator'

class GlobalResolutionWorker {
  constructor(queueName) {
    this.worker = new Worker(queueName, this.processJob.bind(this));
  }

  async processJob(job) {
    const { runId } = job.data;
    const directorySummaries = await sqliteDb.getDirectorySummaries(runId);
    // Also fetch all relationships that could be evaluated at a global level
    const relationshipsToEvaluate = await sqliteDb.getAllRelationshipsForRun(runId);

    const llmContext = buildContextFromSummaries(directorySummaries);
    const llmResponse = await LlmClient.analyzeGlobally(llmContext);

    const relationshipsFoundByLlm = llmResponse.relationships;
    const findings = [];

    for (const rel of relationshipsToEvaluate) {
        const wasFoundInThisPass = checkIfExists(rel, relationshipsFoundByLlm);
        const score = wasFoundInThisPass ? ConfidenceScoringService.getInitialScoreFromLlm(rel.raw) : 0.1;

        findings.push({
            relationshipHash: createRelationshipHash(rel),
            foundRelationship: wasFoundInThisPass,
            initialScore: score,
            rawLlmOutput: rel.raw // The raw output from THIS worker's LLM call
        });
    }

    const eventPayload = {
      runId: runId,
      jobId: job.id,
      sourceWorker: 'GlobalResolutionWorker',
      findings: findings
    };

    await eventQueue.add('global-analysis-completed', eventPayload);
  }
}